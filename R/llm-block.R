#' LLM block constructor
#'
#' Basic constructor for blocks that inherit from `llm_block`. Intended to be
#' used for more specific block classes such as LLM-based transform or plot
#' blocks.`)
#'
#' @param question LLM prompt
#' @param code Code as generated by the LLM
#' @param explanation Explanation for the generated code
#' @param max_retries Number of retries in case of erroneous code
#' @param enable_image_upload Whether to enable image upload functionality
#' @param ... Forwarded to [blockr.core::new_block()]
#' @inheritParams blockr.core::new_block
#'
#' @return All blocks constructed via `new_llm_block()` inherit from
#' `llm_block`.
#'
#' @export
new_llm_block <- function(class, question = "", code = "",
                          explanation = character(),
                          max_retries = blockr_option("max_retries", 3L),
                          enable_image_upload = FALSE,
                          ctor = sys.parent(),
                          ...) {

  cls <- c(class, "llm_block")

  llm_obj <- structure(
    list(question = question, code = code, explanation = explanation,
         max_retries = max_retries, enable_image_upload = enable_image_upload),
    class = paste0(cls, "_proxy")
  )

  new_block(
    server = llm_block_server(llm_obj),
    ui = llm_block_ui(llm_obj),
    class = cls,
    ctor = ctor,
    allow_empty_state = "explanation",
    ...
  )
}

#' @param x Proxy LLM block object
#' @rdname new_llm_block
#' @export
result_ptype <- function(x) {
  UseMethod("result_ptype")
}
